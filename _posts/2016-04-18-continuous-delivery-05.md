---
layout: default
title: 部署流水线解析
category: Continuous-Delivery
---

# 第五章 部署流水线解析

## 1. 引言

持续集成就能带来很大而效果了，但是持续集成主要关注的是开发团队，但是很多时间是浪费在测试和部署阶段上面的，我们需要一个端到端的方法来交付软件，最好能做到一键构建测试和部署

## 2. 什么是部署流水线

抽象来讲，部署流水线是指软件从版本库到用户手中这一过程的自动话表现形式

部署流水线主要包括四个阶段

* **提交阶段**，从技术上断言系统是可以工作，主要包括编译，单元测试和代码分析等
* **自动化验收测试阶段**，从功能和非功能两个角度断言系统是可以工作的，也说明该系统符合用户的需求规范
* *手工测试阶段**，用于断言系统是可用的，满足了它的系统要求，试图发现那些自动化测试没能发现的问题，并验证系统是否为用户提供了价值。这一阶段包括探索性测试，集成环境上的测试和用户验收测试（UAT）
* **发布阶段**，将软件交付给客户，既可能是以套装软件的形式，也可能是直接将其部署到生产环境或试运行环境

**一个基本的流水线**

![一个基本的流水线](https://github.com/ronniewang/me/blob/gh-pages/image/deploy-pipeline.jpg)

## 3. 部署流水线的相关实践

### 3.1. 只生成一次二进制包

避免两次构建生成的包不一致的情况

> 记住，始终在已知可靠的基础上行进

### 3.2. 对不同环境采用统一的部署方式

将部署流程脚本和配置分离开来，所有的环境都使用一样的流程进行部署

### 3.3. 对部署进行冒烟测试

简单的看看应用是否启动成功，数据库，中间件是否已经启动即可

### 3.4. 向生产环境的副本进行部署

在与生产环境一样的环境中进行测试和持续集成

### 3.5. 每次变更都要立即在流水线中传递

### 3.6. 只要有环节失败，就停止整个流水线

失败了放下手头的活，赶紧修复这个问题，再做别的事

## 4. 提交阶段

一些提交阶段有用的度量标准

* 测试覆盖率
* 重复代码的数量
* 圈复杂度
* 输入耦合度，输出耦合度
* 编译警告的数量
* 代码风格

## 5. 自动化验收测试之门

只有单元测试不一定能保证程序可以运行，也不能保证实现了用户的需求

## 6. 后续的测试阶段

### 6.1. 手工测试

测试人员进行一些手工探索性测试，易用性测试和演示

### 6.2. 非功能测试

容量，安全性，SLA等，参见[第九章]()

## 7. 发布准备

缓解发布风险

* 让参与项目交付过程的人共同创建一个发布计划
* 通过尽可能多的自动化过程最小化为人错误发生的可能性，并从最容易出错的环节开始实现自动化
* 在类生产环境中经常做发布流程的演练，这样就可以对整个流程及其所使用的技术进行测试
* 如果事情没有按计划进行，要有撤销某次发布的能力
* 作为升级和撤销过程的一部分，制定配置迁移和数据迁移的策略

### 7.1. 自动部署与发布

将部署和发布自动化，这样就会频繁的部署，对部署的测试也就更多，也就不怕由部署和发布引入很大的问题了

### 7.2. 变更的撤销

如果部署引发了问题，要有回滚的策略，参见[第十章]()

### 7.3. 在成功的基础上构建

当产生一个候选版本的时候，我们可以确认所有通过部署流水线各个阶段的产物都是成功的

## 8. 实现一个部署流水线

### 8.1. 对价值流进行建模并创建简单的可工作框架

### 8.2. 构建和部署过程的自动化

### 8.3. 自动化单元测试和代码分析

### 8.4. 自动化验收测试

### 8.5. 部署流水线的演进

首先，并不需要一次实现整个流水线，而应该是增量式实现

其次，部署流水线是构建、部署、测试和发布应用程序整个流程中有效的，也是最重要的统计数据来源

最后，部署流水线也需要改进和维护

## 9. 度量



## 10. 小结
