---
layout: default
title: 应用程序的部署与发布
category: continous-delivery
---

# 第十章 应用程序的部署与发布

## 1. 引言

## 2. 创建发布策略

创建发布策略的重要部分就是在项目计划阶段就与应用程序的所有干系人会面

制定部署策略需要考虑以下内容

* 每个环境的部署和发布都是有谁负责的
* 创建一个资产和配置管理策略
* 部署时所用技术的描述, 运维团队和开发团队应对其达成共识
* 实现部署流水线的计划
* 枚举所有环境, 包括用于验收测试, 容量测试, 集成测试, 用户验收测试的环境, 以及每个构建在这些环境中的移动过程
* 描述在测试和生成环境中部署时应该遵循的流程, 比如提交一个变更申请,以及申请授权等
* 对应用程序的监控需求, 包括用于通知运维团队关于应用程序相关状态的API或服务
* 讨论部署和运行时的配置方法如何管理, 以及他们与自动化部署流程是如何关联在一起的
* 描述应用程序如何与所有外部系统集成, 比如, 在哪个阶段进行集成?作为发布过程里的一份子, 如何对这种外部集成进行测试?一旦出现问题, 运维人员如何与供应商进行沟通?
* 如何记录日志详情, 以便运维人员能够确定应用程序的状态, 识别出错原因
* 制定灾难恢复计划, 以便在灾难发送之后, 可以恢复应用程序的状态
* 对软件的服务级别达成一致, 比如, 应用程序是否有像故障转移以及其他高可用策略等方面的需求
* 生成环境的数量大小及容量计划: 应用程序会创建多少数据?需要多少个日志文件或数据库?需要多少带宽或磁盘空间?客户对响应延迟的容忍度是什么?
* 制定一个归档策略, 以便不必为了审计或技术支持而保留生产数据
* 如何对生产环境进行首次部署
* 如何修复生产环境出现的缺陷,并为其打补丁
* 如何升级生成环境的应用程序以及迁移数据
* 如何做应用程序的生产服务和技术支持

### 2.1. 发布计划

* 第一次部署应用程序时所需的步骤
* 作为部署过程的一部分，如何对应用程序以及他所使用的服务进行冒烟测试
* 如果部署出现问题，需要哪些步骤来撤销部署
* 对应用程序的状态进行备份和恢复的步骤是什么
* 在不破坏应用程序状态的前提下，升级应用程序所需要的步骤是什么
* 如果发布失败，重新启动或重新部署应用程序的步骤是什么
* 日志文件放在哪里，以及它包括什么样的信息描述
* 如何对应用程序进行监控
* 作为发布的一部分，对必要的数据进行迁移的步骤有哪些
* 前一次部署问题的记录以及它们的解决方案是什么

### 2.2. 发布产品

对商业软件来说，还有如下考虑

* 收费模式
* 使用许可策略
* 所用第三方技术的版权问题
* 打包
* 市场活动所需要的材料
* 产品文档
* 安装包
* 销售和售后支持团队的准备

## 3. 应用程序的部署和晋级

### 3.1. 首次部署

首次部署一般是在首个迭代结束时，我们认为，这个阶段的只要目标是让部署流水线的前几个阶段可以运行，并能够展示一些成果

首个迭代结束时，应该有以下内容

* 部署流水线的提交阶段
* 一个用于部署的类生产环境
* 通过一个自动化得过程获取在提交阶段生成的二进制包，并将其部署到这个类生产环境中
* 一个简单的冒烟测试，证明本次部署是正确的，并且应用程序正在运行

一般来说，类生产环境有一下特点

* 操作系统与生成环境一致
* 其中安装的软件应该与生产环境一致，尤其不能在其上安装开发工具
* 参见11章的描述，用于管理生产环境相同的方式对这种环境进行管理
* 对于客户自行安装的软件，UAT环境应该基于客户硬件环境的统计结果，具有一定的代表性，至少要基于别人做过的真实统计

### 3.2. 对发布过程进行建模并让构建晋级

使应用程序从一个阶段可以通过部署流水线晋级到下一个阶段

### 3.3. 配置的晋级

### 3.4. 联合环境

几个程序共享一个环境的情况，可能引入两种复杂性

* 保证不同程序的环境配置不会冲突
* 管理好各个程序之间的依赖关系（如果他们之间有依赖的话）

### 3.5. 部署到试运行环境

自动化，预热，冒烟测试

## 4. 部署回滚和零停机发布

快速回滚，避免半夜加班在生产环境上进行调试

首先明确，回滚有两个难点

* 如果发布会修改数据，回滚会比较麻烦
* 如果与其他系统有集成，也比较麻烦

制定回滚计划之前，记住两个通用原则

* 发布前，确保生产系统的状态已经备份（数据库和文件系统）
* 发布前，练习一下回滚计划，确保可以正常工作

### 4.1. 通过重新部署原有的正常版本进行回滚

优点

* 在没有自动回滚流程，但有自动部署流程的情况下，这样风险较低
* 由于执行回滚的频率要低于执行部署的频率，所以重新部署更不容易出错

缺点

* 部署时，系统无法提供服务，导致有停机时间
* 由于覆盖了新版本，导致是去了寻找问题的最佳机会
* 如果新版本运行时产生了数据，回滚到旧版本会使这些数据丢失

### 4.2. 零停机发布

也叫“热部署”，在不影响服务的情况下实现升级和回滚

关键在于发布流程中各部分的解耦，尽量是他们独立发生，尤其是应用程序依赖的共享资源（数据库，静态资源等）被放到了适当的位置

### 4.3. 蓝绿部署

准备两套环境，一套叫“蓝环境”，一套叫“绿环境”

绿环境是当前生产环境，蓝环境是新版本的生产环境，部署新版本后，现在蓝环境上预热一下，没有问题后，直接修改路由，将用户引导到蓝环境即可，如果发现问题，再切回绿环境即可，还可在蓝环境上调试，寻找问题

这种方式的一个问题是小心管理数据，如何将绿环境的数据转移到蓝环境

有两个方法

* 在切换之前，将应用程序变成只读状态，然后复制绿环境数据库到蓝环境，然后在把用户切换到蓝环境
  * 如果一切正常，把应用程序变回读写状态
  * 否则，如果问题发生在切成读写状态之前，则什么都不用做；如果已经写入了一些数据，就需要想个办法将新纪录迁回绿环境，也可以让新版本将数据同时发向两个数据库
* 重新设计应用程序，以便让迁移数据与升级流程独立，参见12章

如果只有一套环境，也可以实现蓝绿部署，只要保证每个应用程序副本都有自己独立的资源（文件目录，端口，数据库等）即可

### 4.4. 金丝雀发布

先迁过去一小批用户，主键增加负载，如果发现问题，可以快速回滚

## 5. 紧急修复

> 记住: 任何情况下, 不能破坏流程

如果紧急恢复之后直接上到了生产环境, 就会产生一个未受控版本, 这会导致两个问题

* 本次修复未经过测试, 不能确定是否真的修复了问题, 也无法确定是否引入了回归问题
* 本次修改未记录在案, 使环境处于一种未知状态

有时候事情并不是那么紧急, 还有时候回滚比修复要更好

## 6. 持续部署

一切都自动化, 提交之后, 自动化部署到生产环境, 这要求自动化测试异常强大, 单元测试, 组件测试, 验收测试, 容量测试

终极目标, 逐步实现, 按下不表, 回头再看

## 7. 部署贴士和窍门

* 真正执行部署操作的人应该参与部署过程的创建，项目开始时，让开发人员和部署人员都知道要做什么
* 记录部署活动，特别是没有完全自动化的时候，人的记忆不靠谱
* 不要删除旧文件
* 新旧版本放在不同的文件夹下
* 部署应该是所有人都会的活动
* 服务器应用程序不应该有GUI，免除非要通过登录界面才能重启服务的尴尬
* 为新部署留预热期，“金丝雀”发布
* 快速失败，部署脚本也要有冒烟测试
* 不要直接对生产环境进行任何修改
